<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Spring 使用笔记之(二) - AOP和Interceptor(拦截器) - 海波的博客</title>

	<link rel="shortcut icon" href="/styles/images/favicon.png">
	<link rel="icon" href="/styles/images/favicon.png">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/styles/css/syntax.css">
	<link rel="canonical" href="/2015/01/28/04-spring-AOP/">
	<link rel="alternate" type="application/rss+xml" title="海波的博客" href="/feed.xml">

	<meta name="keywords" content="Spring 使用笔记之(二) - AOP和Interceptor(拦截器), 海波的博客, 葛海波;个人博客;">
	<meta name="description" content="葛海波;个人博客;">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?";
		  var s = document.getElementsByTagName("script")[0];
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>


  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <!-- <a href="/" class="navbar-brand">
        <img src="/styles/images/logo.jpg">
      </a> -->
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">大类分解</a>
        </li>
        <li>
          <a href="/tag">小类内聚</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <!-- <li>
            <a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></a>
        </li> -->
        <li>
          <a href="/donate/"><strong>打赏</strong></a>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/gehaibo">Github</a></li>
            <li><a rel="nofollow" target="_blank" href="">关于作者</a></li>
            <li><a rel="nofollow" href="/books">我的书单</a></li>
            <li><a rel="nofollow" href="/reference">推荐博客</a></li>
            <!-- <li><a href="/feed.xml">RSS订阅</a></li> -->
            <!-- <li class="divider"></li> -->
            <!-- <li><a rel="nofollow" target="_blank" href="https://github.com/gehaibo/gehaibo.github.com">本项目</a></li> -->
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>

    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>Spring 使用笔记之(二) - AOP和Interceptor(拦截器)</h1>
		    <p>Post on Jan 28, 2015 by <a href="/about">ghb</a></p>
		-->
		    <h1>Make it right before you make it faster.</h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#技术文档-ref">技术文档</a>	/
    	<a href="/tag/#Spring-ref">Spring</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2017">2017</a>
          <ul class="nav">
            <li><a href="#month_2017_April">April</a></li>
      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_March">March</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2016">2016</a>
            <ul class="nav">
              <li><a href="#month_2016_December">December</a></li>
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_November">November</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_October">October</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_September">September</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_June">June</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_May">May</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_March">March</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2015">2015</a>
            <ul class="nav">
              <li><a href="#month_2015_March">March</a></li>
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div> 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">Spring 使用笔记之(二) - AOP和Interceptor(拦截器)</h1>
              <!--
                <p class="post-meta">Jan 28, 2015</p>
              -->
              <div class="meta">Posted on <span class="postdate">Jan 28, 2015</span> By <a target="_blank" href="http://localhost:4000">ghb</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#什么是aop" id="markdown-toc-什么是aop">什么是AOP</a></li>
  <li><a href="#aop在spring中的术语" id="markdown-toc-aop在spring中的术语">AOP在Spring中的术语</a></li>
  <li><a href="#aop在spring中的支持" id="markdown-toc-aop在spring中的支持">AOP在Spring中的支持</a></li>
  <li><a href="#拦截器interceptor的三种实现" id="markdown-toc-拦截器interceptor的三种实现">拦截器(Interceptor)的三种实现</a></li>
  <li><a href="#xml配置方式" id="markdown-toc-xml配置方式">XML配置方式</a></li>
  <li><a href="#基于spring定义的methodinterceptor" id="markdown-toc-基于spring定义的methodinterceptor">基于Spring定义的MethodInterceptor</a></li>
  <li><a href="#纯注解方式" id="markdown-toc-纯注解方式">纯注解方式</a>    <ul>
      <li><a href="#注意" id="markdown-toc-注意">注意</a></li>
    </ul>
  </li>
  <li><a href="#参考资料" id="markdown-toc-参考资料">参考资料</a></li>
</ul>

<h2 id="什么是aop">什么是AOP</h2>

<p>AOP(Aspect Oriented Programming)即:面向切面编程, 通过预编译方式和运行期动态代理实现程序功能的统一维护的一种技术</p>

<h2 id="aop在spring中的术语">AOP在Spring中的术语</h2>
<ul>
  <li>通知(advice)
    <ul>
      <li>Before</li>
      <li>After</li>
      <li>After-Returning</li>
      <li>After-Throwing</li>
      <li>Around</li>
    </ul>
  </li>
  <li>连接点(JointPoing)</li>
  <li>切点(PointCut)</li>
  <li>切面(Aspect)</li>
  <li>引入(Introduction)</li>
  <li>织入(Weaving)
    <ul>
      <li>编译器 - AspectJ的做法</li>
      <li>类加载期 - AspectJ 5的LTW(Load-time weaving)的做法</li>
      <li>运行期 - Spring的做法</li>
    </ul>
  </li>
</ul>

<h2 id="aop在spring中的支持">AOP在Spring中的支持</h2>
<ul>
  <li>基于代理的的经典AOP - 只能代理接口</li>
  <li>基于@AspectJ注解驱动的切面 - 只能代理类</li>
  <li>纯POJO切面</li>
  <li>注入式AspectJ切面</li>
</ul>

<h2 id="拦截器interceptor的三种实现">拦截器(Interceptor)的三种实现</h2>

<ul>
  <li>
    <h1 id="xml配置方式">XML配置方式</h1>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;aop:config&gt;</span>
	<span class="nt">&lt;aop:aspect</span> <span class="na">ref=</span><span class="s">"testInterceptor"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;aop:pointcut</span> <span class="na">expression=</span><span class="s">"execution(public * com.freud.test..*.*(..))"</span>
			<span class="na">id=</span><span class="s">"testPointCut"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;aop:after</span> <span class="na">method=</span><span class="s">"after"</span> <span class="na">pointcut-ref=</span><span class="s">"testPointCut"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;aop:before</span> <span class="na">method=</span><span class="s">"before"</span> <span class="na">pointcut-ref=</span><span class="s">"testPointCut"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/aop:aspect&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"testInterceptor"</span> <span class="na">class=</span><span class="s">"com.freud.TestInterceptor"</span> <span class="nt">/&gt;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">freud</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestInterceptor</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">after</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">before</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"before"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<ul>
  <li>
    <h1 id="基于spring定义的methodinterceptor">基于Spring定义的MethodInterceptor</h1>
  </li>
  <li>在Spring中共提供了四种Advice用来支持对方法调用时施加的不同行为
    <ul>
      <li>BeforeAdvice：具体接口：MethodBeforeAdvice　在目标方法调用之前调用的Advice</li>
      <li>AfterAdvice：具体接口：AfterReturningAdvice　在目标方法调用并返回之后调用的Advice</li>
      <li>AroundAdvice：具休接口：MethodInterceptor　在目标方法的整个执行前后有效,并且有能力控制目标方法的执行</li>
      <li>ThrowsAdvice：具体接口：ThrowsAdvice　在目标方法抛出异常时调用的Advice</li>
    </ul>
  </li>
  <li>在以上四种Advice中最为特别的就是MethodInterceptor：方法拦截器.它的特别之处在于：首先他所在的包并不Srping中的包而是：org.aopalliance.intercept包.即MethodInterceptor实现了AOP联盟接口,这一点保证了它较之其他的Advice更具有通用性,因为它可以在任何基于AOP联盟接口实现的AOP系统中使用.第二点也就是其最为突出的一点就是它所具有的其他Advice所不能匹敌的功能：在目标方法的整个执行前后有效,并且有能力控制目标方法的执行！</li>
</ul>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"testInterceptor"</span> <span class="na">class=</span><span class="s">"com.freud.Interceptor.TestInterceptor"</span><span class="nt">&gt;&lt;/bean&gt;</span>
	
<span class="nt">&lt;aop:config</span> <span class="nt">&gt;</span>
	<span class="c">&lt;!--切入点--&gt;</span>
	<span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"testPointCut"</span> <span class="na">expression=</span><span class="s">"execution(public * com.freud.test.*.*(..))"</span><span class="nt">/&gt;</span>			
	
	<span class="c">&lt;!-- 在该切入点使用自定义拦截器 --&gt;</span>
	<span class="nt">&lt;aop:advisor</span> <span class="na">pointcut-ref=</span><span class="s">"testPointCut"</span> <span class="na">advice-ref=</span><span class="s">"testInterceptor"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/aop:config&gt;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">freud</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">interceptor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.aopalliance.intercept.MethodInterceptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aopalliance.intercept.MethodInvocation</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestInterceptor</span> <span class="kd">implements</span> <span class="n">MethodInterceptor</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">MethodInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
		
		<span class="c1">//Do something before</span>
		
		<span class="n">Object</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
		
		<span class="c1">//Do something After</span>
		
		<span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<ul>
  <li>
    <h1 id="纯注解方式">纯注解方式</h1>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
	<span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
	<span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
	<span class="na">xsi:schemaLocation=</span><span class="s">"</span>
	<span class="err">http://www.springframework.org/schema/beans</span>
	<span class="err">http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span>
	<span class="err">http://www.springframework.org/schema/aop</span>
	<span class="err">http://www.springframework.org/schema/aop/spring-aop.xsd"</span><span class="nt">&gt;</span>
<span class="nt">&lt;aop:aspectj-autoproxy</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.aspectj.lang.JoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.After</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.AfterReturning</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.AfterThrowing</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Pointcut</span><span class="o">;</span>

<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestInterceptor</span> <span class="o">{</span>

	<span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"execution(public * com.freud.interceptor.*.insert*(..))||execution(* com.freud.interceptor.*.add*(..))"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">()</span> <span class="o">{</span>

	<span class="o">}</span>

	<span class="nd">@AfterReturning</span><span class="o">(</span><span class="s">"insert()"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterReturn</span><span class="o">(</span><span class="n">JoinPoint</span> <span class="n">jp</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"AfterReturn"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@After</span><span class="o">(</span><span class="s">"insert()"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfter</span><span class="o">(</span><span class="n">JoinPoint</span> <span class="n">jp</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"After"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Before</span><span class="o">(</span><span class="s">"insert()"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doBefore</span><span class="o">(</span><span class="n">JoinPoint</span> <span class="n">jp</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Before"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@AfterThrowing</span><span class="o">(</span><span class="s">"insert()"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAfterThrowing</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"AfterThrowing"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Around</span><span class="o">(</span><span class="s">"insert()"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doAround</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Around"</span><span class="o">);</span>
	<span class="o">}</span>

<span class="o">}</span></code></pre></figure>

<h2 id="注意">注意</h2>
<blockquote>
  <p>在使用的过程中，如果Spring AOP和 Spring MVC集成，对Controller及之前的层面进行拦截，需要配置在同webcontext目录下的ApplicationContext文件中，不能配置在源目录下，否则会出现不执行拦截器的现象。</p>
</blockquote>

<h1 id="参考资料">参考资料</h1>

<p>《Spring in Action》</p>

<p><a href="http://blog.csdn.net/zhangweikai966/article/details/6334366">http://blog.csdn.net/zhangweikai966/article/details/6334366</a></p>

            </article>
        </div>
      </div>
      <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
             
          </div>
        </article>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2014-2017 <a href=""><code>ghb</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, themed from <a href="http://lesscss.cn/">Less</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/lessismore.js"></script>
<script src="/styles/js/application.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  </body>
</html>
