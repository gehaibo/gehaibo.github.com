<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Java NIO系列学习笔记（二） - Buffer - 海波的博客</title>

	<link rel="shortcut icon" href="/styles/images/favicon.png">
	<link rel="icon" href="/styles/images/favicon.png">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/styles/css/syntax.css">
	<link rel="canonical" href="/2017/03/28/java-nio-02-buffer/">
	<link rel="alternate" type="application/rss+xml" title="海波的博客" href="/feed.xml">

	<meta name="keywords" content="Java NIO系列学习笔记（二） - Buffer, 海波的博客, 葛海波;个人博客;">
	<meta name="description" content="葛海波;个人博客;">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?";
		  var s = document.getElementsByTagName("script")[0];
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>


  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <!-- <a href="/" class="navbar-brand">
        <img src="/styles/images/logo.jpg">
      </a> -->
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">大类分解</a>
        </li>
        <li>
          <a href="/tag">小类内聚</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <!-- <li>
            <a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></a>
        </li> -->
        <li>
          <a href="/donate/"><strong>打赏</strong></a>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/gehaibo">Github</a></li>
            <li><a rel="nofollow" target="_blank" href="">关于作者</a></li>
            <li><a rel="nofollow" href="/books">我的书单</a></li>
            <li><a rel="nofollow" href="/reference">推荐博客</a></li>
            <!-- <li><a href="/feed.xml">RSS订阅</a></li> -->
            <!-- <li class="divider"></li> -->
            <!-- <li><a rel="nofollow" target="_blank" href="https://github.com/gehaibo/gehaibo.github.com">本项目</a></li> -->
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>

    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>Java NIO系列学习笔记（二） - Buffer</h1>
		    <p>Post on Mar 28, 2017 by <a href="/about">ghb</a></p>
		-->
		    <h1>Make it right before you make it faster.</h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#技术文档-ref">技术文档</a>	/
    	<a href="/tag/#nio-ref">nio</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2017">2017</a>
          <ul class="nav">
            <li><a href="#month_2017_April">April</a></li>
      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_March">March</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2016">2016</a>
            <ul class="nav">
              <li><a href="#month_2016_December">December</a></li>
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_November">November</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_October">October</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_September">September</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_June">June</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_May">May</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_March">March</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2015">2015</a>
            <ul class="nav">
              <li><a href="#month_2015_March">March</a></li>
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div> 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">Java NIO系列学习笔记（二） - Buffer</h1>
              <!--
                <p class="post-meta">Mar 28, 2017</p>
              -->
              <div class="meta">Posted on <span class="postdate">Mar 28, 2017</span> By <a target="_blank" href="http://localhost:4000">ghb</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#buffer" id="markdown-toc-buffer">Buffer</a></li>
  <li><a href="#buffer用法示例" id="markdown-toc-buffer用法示例">Buffer用法示例</a>    <ul>
      <li><a href="#bytebuffertesttxt" id="markdown-toc-bytebuffertesttxt">ByteBufferTest.txt</a></li>
      <li><a href="#bytebuffertestjava" id="markdown-toc-bytebuffertestjava">ByteBufferTest.java</a></li>
      <li><a href="#输出结果" id="markdown-toc-输出结果">输出结果</a></li>
      <li><a href="#分析" id="markdown-toc-分析">分析</a></li>
    </ul>
  </li>
  <li><a href="#mark-position-limit-capacity" id="markdown-toc-mark-position-limit-capacity">mark position limit capacity</a>    <ul>
      <li><a href="#释义" id="markdown-toc-释义">释义</a></li>
      <li><a href="#初始值" id="markdown-toc-初始值">初始值</a></li>
    </ul>
  </li>
  <li><a href="#buffer-1" id="markdown-toc-buffer-1">Buffer</a>    <ul>
      <li><a href="#positionint" id="markdown-toc-positionint">position(int)</a></li>
      <li><a href="#limitint" id="markdown-toc-limitint">limit(int)</a></li>
      <li><a href="#mark" id="markdown-toc-mark">mark()</a></li>
      <li><a href="#reset" id="markdown-toc-reset">reset()</a></li>
      <li><a href="#clear" id="markdown-toc-clear">clear()</a></li>
      <li><a href="#flip" id="markdown-toc-flip">flip()</a></li>
      <li><a href="#rewind" id="markdown-toc-rewind">rewind()</a></li>
      <li><a href="#hasremaining" id="markdown-toc-hasremaining">hasRemaining()</a></li>
      <li><a href="#remaining" id="markdown-toc-remaining">remaining()</a></li>
    </ul>
  </li>
  <li><a href="#bytebuffer" id="markdown-toc-bytebuffer">ByteBuffer</a>    <ul>
      <li><a href="#buffer分配" id="markdown-toc-buffer分配">Buffer分配</a></li>
      <li><a href="#compareto" id="markdown-toc-compareto">compareTo</a></li>
    </ul>
  </li>
  <li><a href="#heapbytebuffer" id="markdown-toc-heapbytebuffer">HeapByteBuffer</a>    <ul>
      <li><a href="#分配空间" id="markdown-toc-分配空间">分配空间</a></li>
      <li><a href="#写入" id="markdown-toc-写入">写入</a></li>
      <li><a href="#读取" id="markdown-toc-读取">读取</a></li>
      <li><a href="#浅复制" id="markdown-toc-浅复制">浅复制</a></li>
      <li><a href="#深复制" id="markdown-toc-深复制">深复制</a></li>
    </ul>
  </li>
  <li><a href="#参考资料" id="markdown-toc-参考资料">参考资料</a></li>
</ul>

<h1 id="buffer">Buffer</h1>

<p>上一节中已经讲过，Buffer有如下几种，其中最常用的是ByteBuffer:</p>

<p><img src="/images/blog/java-nio/01-introduction/02-buffer-hierarchy.png" alt="/images/blog/java-nio/01-introduction/02-buffer-hierarchy.png" /></p>

<h1 id="buffer用法示例">Buffer用法示例</h1>

<h2 id="bytebuffertesttxt">ByteBufferTest.txt</h2>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Hello World!</code></pre></figure>

<h2 id="bytebuffertestjava">ByteBufferTest.java</h2>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">freud</span><span class="o">.</span><span class="na">nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.RandomAccessFile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author Freud
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ByteBufferTest</span> <span class="o">{</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">RandomAccessFile</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span>
				<span class="s">"resources/ByteBufferTest.txt"</span><span class="o">),</span> <span class="s">"rw"</span><span class="o">);</span>
		<span class="n">FileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
		<span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
            <span class="n">print1</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">print2</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="n">buffer</span><span class="o">.</span><span class="na">mark</span><span class="o">();</span>
        <span class="o">}</span>
		<span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">file</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 打印ByteBuffer中所有的字节
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">print1</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Print by print1 : "</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">b</span> <span class="o">:</span> <span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">b</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 按照字节逐个打印
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">print2</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"Print by print2 : "</span><span class="o">);</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
		<span class="o">}</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h2 id="输出结果">输出结果</h2>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Print by print1 : Hello Worl
Print by print2 : Hello Worl
Print by print1 : d!llo Worl
Print by print2 : d!</code></pre></figure>

<h2 id="分析">分析</h2>

<p>以上源码中使用RandomAccessFile读取了本地磁盘的一个文件，通过FileChannel写入到ByteBuffer中，再从ByteBuffer中打印到输出控制台上。</p>

<p>但很明显的可以看到方法print1的第二次打印明显不是我们预期的结果，在clear之后本能的想法是buffer应该被清空了，但是为什么还会有上次的读取结果，产生这个结果的原因正是ByteBuffer的数据模型造成的。在下面的介绍中我们会详细介绍产生的原因。</p>

<h1 id="mark-position-limit-capacity">mark position limit capacity</h1>

<p>Buffer分为读模式(从Buffer中读取数据)和写模式(写数据到Buffer中)，模式的切换是通过flip来实现的，在不同的模式下position和limit的概念是不同的，而capacity和mark是相同的。</p>

<h2 id="释义">释义</h2>

<table>
  <tbody>
    <tr>
      <td>position</td>
      <td>当写模式下时，position当前位置，初始的position值为0.当一个byte、long等数据写到Buffer后， position会向前移动到下一个可插入数据的Buffer单元。position最大可为capacity–1；在读模式下时，也是从某个特定位置读。当将Buffer从写模式切换到读模式，position会被重置为0. 当从Buffer的position处读取数据时，position向前移动到下一个可读的位置。</td>
    </tr>
    <tr>
      <td>limit</td>
      <td>在写模式下，Buffer的limit表示你最多能往Buffer里写多少数据。 写模式下，limit等于Buffer的capacity。</td>
    </tr>
    <tr>
      <td>capacity</td>
      <td>作为一个内存块，Buffer有一个固定的大小值，也叫“capacity”.你只能往里写capacity个byte、long，char等类型。一旦Buffer满了，需要将其清空（通过读数据或者清除数据）才能继续写数据往里写数据。</td>
    </tr>
    <tr>
      <td>mark</td>
      <td>标记，可以通过mark()方法记录当前position值，然后通过reset()方法可以使position重新回到mark的位置，而clear()、rewind()、flip()方法总是会重置mark为初始状态-1</td>
    </tr>
  </tbody>
</table>

<h2 id="初始值">初始值</h2>

<p><img src="/images/blog/java-nio/02-buffer/02-mark-position-limit-capacity.png" alt="/images/blog/java-nio/02-buffer/02-mark-position-limit-capacity.png" /></p>

<h1 id="buffer-1">Buffer</h1>

<p>Buffer的API中大量使用链式编程设计，使得API调用非常顺畅而自然。</p>

<p><img src="/images/blog/java-nio/02-buffer/01-buffer-api.png" alt="/images/blog/java-nio/02-buffer/01-buffer-api.png" /></p>

<h2 id="positionint">position(int)</h2>

<p>需要注意的是当设置当前position的时候，如果之前设置了mark，那么如果mark值大于position，则会重置mark为初始状态。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">position</span><span class="o">(</span><span class="kt">int</span> <span class="n">newPosition</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">newPosition</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">newPosition</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">newPosition</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mark</span> <span class="o">&gt;</span> <span class="n">position</span><span class="o">)</span> <span class="n">mark</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="limitint">limit(int)</h2>

<p>设置limit跟设置position是类似的，不只设置了limit的值，如果当前position大于要设置的limit，则将position赋值为最新的limit，如果mark大于要设置的limit，则重置mark为初始状态。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">limit</span><span class="o">(</span><span class="kt">int</span> <span class="n">newLimit</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">newLimit</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">newLimit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">newLimit</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="o">)</span> <span class="n">position</span> <span class="o">=</span> <span class="n">limit</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mark</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="o">)</span> <span class="n">mark</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="mark">mark()</h2>

<p>mark是标记mark值为当前的position值。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">mark</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mark</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="reset">reset()</h2>

<p>如果标记了mark，重置position回到当初标记的mark位置。没有标记过mark，则抛出异常。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">reset</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mark</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidMarkException</span><span class="o">();</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">m</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="clear">clear()</h2>

<p>clear其实是设置position，limit，mark的值回到初始值状态。这也就解释了为什么刚开始的Demo中print1第二次打印出的并非我们预期的结果，原因是clear只是重置了这些游标数值。并没有真正的清空buffer中的内容。当从读模式切换到写模式的时候需要调用clear()方法。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">capacity</span><span class="o">;</span>
    <span class="n">mark</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="flip">flip()</h2>

<p>设置limit为position的值，即当前读取到的byte,long等总和-1位置。重置position和mark回到初始值。当从写模式变为读模式的时候需要调用flip()方法.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">flip</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span>
    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">mark</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="rewind">rewind()</h2>

<p>rewind跟flip有些类似，只是并没有修改limit的值。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">Buffer</span> <span class="nf">rewind</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">mark</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="hasremaining">hasRemaining()</h2>

<p>通过判断limit-position的值来判断Buffer中是否还有未读取的元素。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasRemaining</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">position</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="remaining">remaining()</h2>

<p>与hasRemaining相似，只是返回了未读取的元素个数，更详细。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">remaining</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">limit</span> <span class="o">-</span> <span class="n">position</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<h1 id="bytebuffer">ByteBuffer</h1>

<h2 id="buffer分配">Buffer分配</h2>

<p>要想获得一个Buffer对象首先要进行分配。 每一个Buffer的实现类都有一个allocate方法。而ByteBuffer实际底层源代码是创建了一个HeapByteBuffer对象。也可以通过allocateDirect方法创建一个DirectByteBuffer对象。HeapByteBuffer和DirectByteBuffer的不同之处在与，HeapByteBuffer分配的内存在JVM Heap上，而DirectByteBuffer分配的内存在C的Heap上。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">ByteBuffer</span> <span class="nf">allocateDirect</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">DirectByteBuffer</span><span class="o">(</span><span class="n">capacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">ByteBuffer</span> <span class="nf">allocate</span><span class="o">(</span><span class="kt">int</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">capacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">HeapByteBuffer</span><span class="o">(</span><span class="n">capacity</span><span class="o">,</span> <span class="n">capacity</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="compareto">compareTo</h2>

<p>ByteBuffer实现了Comparable接口，所以两个ByteBuffer对象是可以比较的。而比较的逻辑是比较从position到limit之间的元素是否相同。源码如下：</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">+</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">remaining</span><span class="o">(),</span> <span class="n">that</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">position</span><span class="o">(),</span> <span class="n">j</span> <span class="o">=</span> <span class="n">that</span><span class="o">.</span><span class="na">position</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++,</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">that</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="n">cmp</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">remaining</span><span class="o">()</span> <span class="o">-</span> <span class="n">that</span><span class="o">.</span><span class="na">remaining</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="kt">byte</span> <span class="n">x</span><span class="o">,</span> <span class="kt">byte</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">Byte</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h1 id="heapbytebuffer">HeapByteBuffer</h1>

<p>接下来拿HeapByteBuffer来看下怎样向Buffer中写入和读取数据的。</p>

<h2 id="分配空间">分配空间</h2>

<p>HeapByteBuffer在初始化的时候创建了一个长度为cap的byte数组。而所有的元素都是存储在这个数组中，所有的操作都是针对这个数组的操作。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="n">HeapByteBuffer</span><span class="o">(</span><span class="kt">int</span> <span class="n">cap</span><span class="o">,</span> <span class="kt">int</span> <span class="n">lim</span><span class="o">)</span> <span class="o">{</span><span class="c1">// package-private</span>
	<span class="c1">// ByteBuffer(int mark, int pos, int lim, int cap, byte[] hb, int offset)</span>
    <span class="kd">super</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">lim</span><span class="o">,</span> <span class="n">cap</span><span class="o">,</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">cap</span><span class="o">],</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="写入">写入</h2>

<p>当写入数据的时候其实是向position位置的byte数组中写入了一个字节，然后position的位置加一直到limit为止。ByteBuffer有很多的重载put方法，但是原理都大同小异。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="n">ByteBuffer</span> <span class="nf">put</span><span class="o">(</span><span class="kt">byte</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">hb</span><span class="o">[</span><span class="n">ix</span><span class="o">(</span><span class="n">nextPutIndex</span><span class="o">())]</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">ix</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kt">int</span> <span class="nf">nextPutIndex</span><span class="o">()</span> <span class="o">{</span><span class="c1">// package-private</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">BufferOverflowException</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">position</span><span class="o">++;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="读取">读取</h2>

<p>读取与写入类似，在当前position位置读取一个字节，然后position加一直到limit为止。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="kt">byte</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">hb</span><span class="o">[</span><span class="n">ix</span><span class="o">(</span><span class="n">nextGetIndex</span><span class="o">())];</span>
<span class="o">}</span>
<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">ix</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">offset</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">final</span> <span class="kt">int</span> <span class="nf">nextGetIndex</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// package-private</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="o">)</span>
    	<span class="k">throw</span> <span class="k">new</span> <span class="nf">BufferUnderflowException</span><span class="o">();</span>
	<span class="k">return</span> <span class="n">position</span><span class="o">++;</span>
<span class="o">}</span></code></pre></figure>

<h2 id="浅复制">浅复制</h2>

<p>浅复制只会复制position到limit之间的元素，并且不会保留mark,position,limit,capacity,offset的状态。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="n">ByteBuffer</span> <span class="nf">slice</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">HeapByteBuffer</span><span class="o">(</span><span class="n">hb</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">remaining</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">remaining</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">+</span> <span class="n">offset</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h2 id="深复制">深复制</h2>

<p>深复制会复制整个对象所维持的状态，包括其中mark,position,limit,capacity,offset的状态。</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 源码</span>
<span class="kd">public</span> <span class="n">ByteBuffer</span> <span class="nf">duplicate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">HeapByteBuffer</span><span class="o">(</span><span class="n">hb</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">markValue</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">position</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">limit</span><span class="o">(),</span> <span class="k">this</span><span class="o">.</span><span class="na">capacity</span><span class="o">(),</span> <span class="n">offset</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<h1 id="参考资料">参考资料</h1>

<p>JAVA-NIO(英文版) - Ron Hitchens</p>

<p>JAVA-NIO(中文版) - Ron Hitchens(著) 裴小星(译)</p>

<p>Java nio tutorial : <a href="http://tutorials.jenkov.com/java-nio/index.html">http://tutorials.jenkov.com/java-nio/index.html</a></p>

<p>并发编程网：Java NIO系列教程-中文翻译版 : <a href="http://ifeve.com/overview/">http://ifeve.com/overview/</a></p>

            </article>
        </div>
      </div>
      <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
             
          </div>
        </article>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2014-2017 <a href=""><code>ghb</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, themed from <a href="http://lesscss.cn/">Less</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/lessismore.js"></script>
<script src="/styles/js/application.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  </body>
</html>
